---
title: "Average time-series for clustered data"
author: "Paul M. Magwene"
date: "April 5, 2017"
output:
  html_document:
    toc: true
    toc_depth: 2
    theme: readable
    highlight: default  
    fig_width: 6
    fig_height: 6
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, prompt = FALSE, eval = TRUE, 
                      comment=NA, warning = FALSE, results="show",
                      message = FALSE, cache = TRUE)
```

## Goal

To generate a figure depicting the time series behavior of genes in different clusters. Overlain over the individual gene expression time series, we'll overlay the average time series for each cluster. I illustrate this with clusters generated by hierarchical clustering. This is easily adapted to clusterings generated by other methods.


## Libraries

```{r}
library(dendextend)
library(tidyr)
library(dplyr)
library(magrittr)
library(ggplot2)
```

## Load and restructure the data
```{r}
# load data in "wide" format (genes in columns)
spellman <- read.csv("spellman-reformated.csv")

# restructure in "long" format
spellman.long <- gather(spellman, gene, expression, -expt, -time)
```

## Calculate gene-gene correlations

```{r}
# calculate corr based on alpha factor expt measures
alpha.cor <- 
  spellman %>%
  filter(expt == "alpha") %>%
  select(-expt, -time) %>%
  cor(use="pairwise.complete.obs")
```

## Cluster the data using hierarchical clustering

```{r}
# cluster the alpha factor data using hclust
alpha.clust <-
  as.dist(1 - alpha.cor) %>%
  hclust(method="complete")
```

Cut the tree to get a specific set of cluster to visualize.

```{r}
# cut tree, to yield 8 clusters
clusters <- dendextend::cutree(alpha.clust, k=8, 
                               order_clusters_as_data = TRUE)

```


Create a data frame holding cluster membership for each gene.

```{r}
clusters.df <- data.frame(gene = names(clusters), 
                          cluster = as.factor(clusters))
```

## Combining the cluster assignments with the original data

For the purposes of easy plotting in ggplot, we want to combine the information about cluster assignment to the original data.  However the cluster assignments and corresponding names aren't necessarily in the same order as our original data frame. We'll use a "left join" to combine the two data frames, matching on the "gene" column:

```{r}
# do a left_join, combining the information in spellman.long
# with clusters.df (matched on gene).  This effectively adds the
# cluster information as a new column to spellman.long data frame
# keeping the appropriate matches by gene name
alpha.long <- 
  spellman.long %>%
  filter(expt == "alpha") %>%
  left_join(clusters.df, by = c("gene"))
```


## Clusters means

```{r}
# calculate the mean at each time point within each cluster
cluster.means <-
  alpha.long %>%
  group_by(cluster, time) %>%
  summarize(mean.exp = mean(expression, na.rm = TRUE))
```

## Final plot

```{r, fig.width = 7}
# draw a figure showing time varying gene expression
# in each cluster, overlain with the each clusters 
# mean time series
alpha.long %>%
  ggplot(aes(time, expression, group=gene)) +
  geom_line(alpha=0.25) + 
  geom_line(aes(time, mean.exp, group=NULL,color=cluster),
            data = cluster.means,
            size=1.1) +
  facet_wrap(~cluster, ncol=4)
```